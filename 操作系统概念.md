# 操作系统概念期末复习

## 导论

### 操作系统的功能

#### 计算机系统的组成

计算机系统可粗略地分为四个组件：硬件、操作系统、应用程序和用户

#### 两个视角

用户视角--OS设计的目的是为了使计算机系统更容易使用，性能是次要的

系统视角--OS是资源分配器，控制程序

- 资源分配器：操作系统管理计算机系统的资源(CPU时间、内存空间、文件存储空间、I/O设备等)
- 控制程序：操作系统管理用户程序的执行，以防止计算机资源的错误或不正当使用

#### 操作系统的定义

操作系统是一组控制和管理计算机硬件和软件资源、合理地对各类作业进行调度，以及方便用户的程序集合。操作系统是用户和计算机的接口，同时也是计算机硬件和其他软件的接口



### 计算机系统的组成

#### 中断

事件发生通过硬件或软件的**中断**(interrupt)来通知。硬件可以随时通过系统总线发送信号到CPU，以触发中断。软件也可以通过执行特别操作 **系统调用**(system call)来触发中断

CPU如何处理中断？

1. 保护断点:即保存下一将要执行的指令的地址，就是把这个地址送入堆栈。
2. 寻找中断入口:根据不同的中断源所产生的中断向量，查找不同的入口地址，入口地址处存放着中断处理程序

3. 执行中断处理程序
4. 中断返回:执行完中断指令后，就从中断处返回到主程序，继续执行



#### 陷阱 trap

陷阱是一种软件产生的中断(也叫做异常)，源于程序出错(如除0，访问内存无效)或者源于用户程序的**特别请求**(system call)，完成中断处理后将CPU控制权再交给提出陷阱请求的程序



#### 中断和陷阱的区别

陷阱又叫做软中断，与中断相比，陷阱是软件实现的中断，也就是程序运行时其他程序对它的中断；中断是硬件实现的中断，是程序运行时设备对它的中断。

- 硬中断是由外部事件引起的，具有突发性和随机性
- 软中断的发生不是随机的，而是程序安排好的



### 计算机体系结构

#### 计算机体系结构分类

单处理器系统

多处理器系统

集群系统



#### **多处理器系统中对称多处理和非对称多处理的区别**

非对称多处理(AMP) 处理器之间是主从关系、一个主处理器控制系统向其他从处理器分配任务，主处理器单独做I/O任务

对称多处理(SMP)处理器之间是平等的关系，I/O可以被任一处理器处理



#### **多处理器的优点**

1. 增加吞吐量
2. 规模经济
3. 增加可靠性



### 操作系统的结构

#### 多道程序的概念

**多道程序设计**通过安排作业，使得CPU总有一个执行任务，从而提高CPU利用率

操作系统同时把多个任务保存在内存中，如果一个执行中的任务需要等待一个事件完成则CPU切换到另一个任务并执行而不是空等待原任务完成



#### 三种主要的操作系统

1. 批处理系统

用户将作业交给系统操作员，系统操作员将许多用户的作业组成一批作业之后输入到计算机中，在系统中形成一个自动转接的连续的作业流，系统自动，依次执行每个作业，最后由操作员将作业结果交给用户

优点：作业流程自动化；效率高、吞吐量高

缺点：无交互手段；调试程序困难

2. 分时系统

操作系统将CPU的时间划分为若干个片段，称为`时间片`。操作系统以时间片为单位，在用户间快速切换，轮流为每个终端用户服务，每次服务一个时间片。系统的快速切换使用户感到整个系统只为自己所用。是多道程序设计的延伸，由于切换频率很高，用户可以在程序运行期间与之进行交互

3. 实时系统

指当外界事件或数据产生时，能够接受并以足够快的速度予以处理，其处理的结果又能在规定的时间之内来控制生产过程或对处理系统作出快速响应，并控制所有实时任务协调一致运行的操作系统。



### 操作系统的执行

现代操作系统是`中断驱动`

操作系统在空闲时会等待某个事件发生，事件是中断或陷阱引起的



#### $\star$双重模式与多重模式的执行

为了确保操作系统的正确运行，必须区分操作系统代码和用户代码的执行。大多数计算机系统采用硬件支持，以便区分各种执行模式



**双重模式**

- 用户模式 1
- 内核模式 0

用一个模式位来表示当前模式 

当用户应用通过系统调用，请求操作系统服务时，系统必须从用户模式切换到内核模式，以满足请求



**特权指令** 可能引起损害的机器指令，硬件只有在内核模式下才允许执行特权指令



#### 定时器

操作系统应该维持控制CPU，防止用户程序陷入死循环，或不调用系统服务并且不讲控制返给操作系统

定时器可设置为指定周期后中断计算机



## 操作系统结构

### 操作系统提供的服务

用户：

- 用户界面(命令行界面、批处理界面、用户图形界面)
- 程序执行
- I/O操作
- 文件系统操作
- 通信
- 错误检测

系统：

- 资源分配
- 记账
- 保护与安全



### 操作系统的用户界面

#### 命令解释程序

获取并执行用户指定的下一步命令

执行命令的两种方法

1. 命令解释程序本身包含代码以执行这些命令
2. 通过系统程序实现大多数命令



#### 用户图形界面



### $\star$ 系统调用

#### 系统调用概念

操作系统内核提供一系列预定功能，通过一组称为系统调用的接口呈现给编程人员系统

调用把应用程序的请求传给内核，系统调用相应的内核函数完成所需的处理将处理结果返回给应用程序。

C或C++编写。系统调用是内核的一部分。



#### 如何找到相应的内核函数?

每个系统调用都有一个相关数字，系统调用接口根据这些数字来创建一个索引列表。

系统调用接口就可调用操作系统内核中的所需系统调用，并返回系统调用状态和任何返回值

![](image/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.png)

#### 三种常用的API

大多数程序设计语言，运行时支持系统提供了系统调用接口,以链接到操作系统的系统调用

1. Win32API
2. POSIXAPI (POSIX系统，UNIX,LINUX,MACOS)

3. JavaAPI



#### 为什么使用API

如果说系统调用是内核和应用程序信息交流的通道，那么API就是程序和开发人员之间交流的通道，它为开发人员掩盖系统调用的细节，提供访问并操作硬件的权利。



API的可移植性强，系统调用细节复杂，操作难度大



#### 操作系统传递参数的三种方法

1. 通过寄存器来传递参数
2. 将参数存在内存的块和表中，将块的地址通过寄存器来传递
3. 参数通过程序压入堆栈，通过操作系统弹出



#### 系统调用的类型

进程控制、文件管理、设备管理、信息维护和通信五大类



### 系统程序

也叫做系统工具，为程序开发和执行提供了一个方便的环境

有的系统程序知识系统调用的简单用户接口，而其他的可能相当复杂

- 文件管理
- 状态信息
- 文件修改
- 编程语言支持
- 程序加载与执行
- 通信



### 操作系统的设计与实现

**机制和策略**

操作系统设计的一个重要原则时策略和机制分离

策略决定做什么

机制决定怎么做



### $\star$操作系统结构

#### 四种结构

**简单结构**

早期的操作系统并没有很好的架构，有些甚至没有区分核心态和用户态。导致系统的不稳定性。

**分层方法**

将操作系统分为多个层次，最底层的是硬件（层０），最高层为用户接口（层Ｎ），每一层都只是依靠于更底层的功能来实现的，这样形成一个层次化的结构。

优点：简化了构造和调试，弊端是层次之间耦合性高，层次之间很难界定。

缺点：层次结构的效率较低，一个系统调用可能要陷入多个层再返回，增加了很多花销

**微内核**

**模块**

采用面向对象的特点，将各个功能模块化，每一个模块之间使用接口进行通讯，必要的时候可以将一部分的内容加载到内核中进行操作。它类似于层次结构，但是模块之间没有上下层的依赖关系，模块之间可以相互调用，更加灵活；它类似于微内核，但是必要时候会将内容加载到内核中，比微核更有效率



#### 微内核

将所有非基本部分从内核中移走，并将它们实现为系统程序或用户程序，从而得到更小的内核。微内核通常包括最小的进程和内存管理以及通信功能。

用户程序和系统服务（运行在用户空间）通过微内核以消息传递形式进行通信，并不会直接交互。

优点：

1. 便于扩充操作系统
2. 操作系统容易移植
3. 更好的安全性和可靠性

缺点：

由于系统功能总开销的增加而导致系统性能的下降（各个服务之间缺少通信，只能依靠微核的信息传递，导致效率下降。）



## 进程

### 进程概念

进程是执行的程序(非正式的说法)，进程包括

- 程序代码(文本段、代码段)
- 当前活动，如程序计数器的值，处理器寄存器的内容
- 进程**堆栈**(stack) 包括临时数据，如函数参数、返回地址和局部变量
- 数据段 包括全局变量
- 进程还可能包括**堆**，进程运行时动态分配的内存

![](image/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B.png)

程序本身不是进程。程序时被动实体，存储在磁盘上包含一系列指令的文件(可执行文件)

进程时活动实体，具有一个程序计数器用于表示下个执行命令和一组相关资源。当一个可执行文件被加载到内存时，这个程序就成为进程



#### ※ 进程状态及转换

![](image/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81%E5%8F%8A%E8%BD%AC%E6%8D%A2.png)



#### ※进程控制块PCB

操作系统采用进程控制块表示进程，也叫做任务控制块，包含许多与某个进程相关的信息

包括：

- 进程状态
- 进程编号
- 程序计数器
- CPU寄存器
- CPU调度信息
- 内存管理西南西
- 记账信息
- I/O状态信息



### ※进程调度

`进程调度器`选择一个可用进程到CPU上执行

 

#### 调度队列

**作业队列** 进程进入系统时，会被加到作业队列，这个队列包括系统内的所有进程

**就绪队列** 驻留在内存中的，就绪的，等待运行的进程保存在就绪队列上

**设备队列** 等待特定I/O设备的进程列表，称为设备列表，每个设备都有自己的设备列表



![](image/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%A1%A8%E7%A4%BA%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9A%84%E9%98%9F%E5%88%97%E5%9B%BE.png)



#### 调度程序

进程选择通过适当调度器或调度

**长期调度程序** (作业调度程序)

从进程缓冲池中选择进程，加到内存中以便执行。

特点：调度频率较低；可以控制系统多道程序度；平衡 I/O 设备与 CPU 的利用率（选择合理的包含 I/O 为主和 CPU 为主的进程的组合）

**短期调度程序**(CPU调度程序)

从准备执行的进程中选择进程，分配CPU

特点：调度频繁；调度快慢影响 CPU 利用率和系统吞吐量

**中期调度程序**

将进程从内存(CPU竞争)中移除，从而降低多道程序程序。之后，进程可被重新调入内存，并从中断处继续执行。这种方案称为**交换**(swap)



**三种调度程序的区别**

长期调度程序又称作业调度程序，从缓冲池中选择进程，装入内存以准备执行。长期调度程序执行得并不频繁，控制**多道程序设计的程度**（内存中的进程数量），还能平衡IO与CPU的利用率



短期作业调度程序又称为CPU调度程序，从准备执行的进程中选择进程，并为止分配CPU。短期调度程序要频繁为CPU选择新进程，执调度速度快，影响CPU的利用率和系统吞吐量



中期调度程序的核心思想是能将进程从内存（或从 CPU 竞争）中移出，从而降低多道程序设计的程度。进程可换出，并在后来可被换入，一种交换（swapping）的方案。



#### 上下文切换

当中断发生时，系统需要保存当前运行在CPU上的进程的上下文，以便在处理后能够恢复上下文，即先挂起进程，再恢复进程。进程上下文用进程PCB表示

通过执行`状态保存`(status save)，保存CPU当前状态

之后`状态恢复`(status restore) 重新开始运行



切换CPU到另一个进程需要保存当前进程状态并恢复另一个进程的状态，这个任务称为`上下文切换`

